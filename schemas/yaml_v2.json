{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://agent-ethan2/schemas/yaml_v2.json",
  "title": "AgentEthan2 YAML configuration v2",
  "type": "object",
  "additionalProperties": false,
  "required": ["meta", "runtime", "providers", "graph"],
  "properties": {
    "histories": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["id"],
        "properties": {
          "id": {"type": "string", "minLength": 1},
          "backend": {
            "type": "object",
            "additionalProperties": true,
            "properties": {
              "type": {"type": "string", "enum": ["memory", "redis"]},
              "url": {"type": "string"},
              "key_prefix": {"type": "string"},
              "max_turns": {"type": "integer", "minimum": 1},
              "ttl": {"type": "integer", "minimum": 1}
            }
          },
          "system_message": {"type": "string"}
        }
      }
    },
    "meta": {
      "type": "object",
      "additionalProperties": false,
      "required": ["version"],
      "properties": {
        "version": {"const": 2},
        "name": {"type": "string"},
        "description": {"type": "string"}
      }
    },
    "runtime": {
      "type": "object",
      "additionalProperties": false,
      "required": ["engine"],
      "properties": {
        "engine": {"type": "string"},
        "graph_name": {"type": "string"},
        "defaults": {
          "type": "object",
          "additionalProperties": {
            "type": ["string", "number", "boolean", "array", "object", "null"]
          }
        },
        "factories": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "providers": {
              "type": "object",
              "additionalProperties": {"type": "string"}
            },
            "tools": {
              "type": "object",
              "additionalProperties": {"type": "string"}
            },
            "components": {
              "type": "object",
              "additionalProperties": {"type": "string"}
            }
          }
        },
        "exporters": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["type"],
            "properties": {
              "type": {"type": "string"},
              "path": {"type": "string"}
            },
            "additionalProperties": true
          }
        }
      }
    },
    "providers": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["id", "type"],
        "properties": {
          "id": {"type": "string", "minLength": 1},
          "type": {"type": "string", "minLength": 1},
          "config": {
            "type": "object",
            "additionalProperties": true
          }
        }
      }
    },
    "tools": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["id", "type"],
        "properties": {
          "id": {"type": "string", "minLength": 1},
          "type": {"type": "string", "minLength": 1},
          "provider": {"type": "string", "minLength": 1},
          "config": {
            "type": "object",
            "additionalProperties": true
          }
        }
      }
    },
    "components": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["id", "type"],
        "properties": {
          "id": {"type": "string", "minLength": 1},
          "type": {"type": "string", "minLength": 1},
          "provider": {"type": "string", "minLength": 1},
          "tool": {"type": "string", "minLength": 1},
          "inputs": {
            "type": "object",
            "additionalProperties": {"type": "string"}
          },
          "outputs": {
            "type": "object",
            "additionalProperties": {"type": "string"}
          },
          "config": {
            "type": "object",
            "additionalProperties": true
          }
        }
      }
    },
    "graph": {
      "type": "object",
      "additionalProperties": false,
      "required": ["entry", "nodes"],
      "properties": {
        "entry": {"type": "string", "minLength": 1},
        "history": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "enabled": {"type": "boolean"},
            "input_key": {"type": "string", "minLength": 1},
            "output_key": {"type": "string", "minLength": 1},
            "max_turns": {"type": "integer", "minimum": 1},
            "system_message": {"type": "string"}
          }
        },
        "nodes": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["id", "type"],
            "properties": {
              "id": {"type": "string", "minLength": 1},
              "type": {"type": "string", "minLength": 1},
              "component": {"type": "string", "minLength": 1},
              "next": {
                "oneOf": [
                  {"type": "string", "minLength": 1},
                  {
                    "type": "array",
                    "items": {"type": "string", "minLength": 1}
                  },
                  {
                    "type": "object",
                    "additionalProperties": {"type": "string"}
                  }
                ]
              },
              "condition": {"type": "string", "minLength": 1},
              "inputs": {
                "type": "object",
                "additionalProperties": {"type": "string"}
              },
              "outputs": {
                "type": "object",
                "additionalProperties": {"type": "string"}
              },
              "config": {
                "type": "object",
                "additionalProperties": true
              }
            }
          }
        },
        "outputs": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["key", "node", "output"],
            "properties": {
              "key": {"type": "string", "minLength": 1},
              "node": {"type": "string", "minLength": 1},
              "output": {"type": "string", "minLength": 1}
            }
          }
        }
      }
    },
    "policies": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "retry": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "default": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "max_attempts": {"type": "integer", "minimum": 1},
                "backoff": {"type": "string"}
              }
            },
            "overrides": {
              "type": "array",
              "items": {
                "type": "object",
                "additionalProperties": false,
                "required": ["target"],
                "properties": {
                  "target": {"type": "string", "minLength": 1},
                  "max_attempts": {"type": "integer", "minimum": 1},
                  "backoff": {"type": "string"}
                }
              }
            }
          }
        },
        "rate_limit": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "providers": {
              "type": "array",
              "items": {
                "type": "object",
                "additionalProperties": false,
                "required": ["target"],
                "properties": {
                  "target": {"type": "string", "minLength": 1},
                  "type": {"type": "string", "enum": ["token_bucket", "fixed_window"]},
                  "capacity": {"type": "integer", "minimum": 1},
                  "refill_rate": {"type": "number", "minimum": 0},
                  "limit": {"type": "integer", "minimum": 1},
                  "window": {"type": "number", "minimum": 0}
                }
              }
            },
            "nodes": {
              "type": "array",
              "items": {
                "type": "object",
                "additionalProperties": false,
                "required": ["target"],
                "properties": {
                  "target": {"type": "string", "minLength": 1},
                  "type": {"type": "string", "enum": ["token_bucket", "fixed_window"]},
                  "capacity": {"type": "integer", "minimum": 1},
                  "refill_rate": {"type": "number", "minimum": 0},
                  "limit": {"type": "integer", "minimum": 1},
                  "window": {"type": "number", "minimum": 0}
                }
              }
            },
            "shared_providers": {
              "type": "object",
              "additionalProperties": {"type": "string"}
            }
          }
        },
        "error": {
          "type": "object",
          "additionalProperties": true
        },
        "masking": {
          "type": "object",
          "additionalProperties": true
        }
      }
    }
  }
}
